services:
  pigeonwarden-dev:
    build: .
    container_name: pigeonwarden-dev
    network_mode: "host"
    privileged: true
    cap_add:
      - SYS_RAWIO
    devices:
      - /dev/vchiq:/dev/vchiq
      - /dev/video0:/dev/video0
    volumes:
      - .:/app
      - /dev:/dev
      - /opt/vc:/opt/vc
    env_file:
      - .env.local
    environment:
      - UDEV=1
      - LD_LIBRARY_PATH=/opt/vc/lib
    command: ["python3", "-m", "pigeonwarden", "run", "dev"]

  pigeonwarden-prod:
    build: .
    container_name: pigeonwarden-prod
    network_mode: "host"
    privileged: true
    cap_add:
      - SYS_RAWIO
    devices:
      - /dev/vchiq:/dev/vchiq
      - /dev/video0:/dev/video0
    depends_on:
      - redis
    env_file:
      - .env.local
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - UDEV=1
      - LD_LIBRARY_PATH=/opt/vc/lib
    volumes:
      - .:/app
      - /dev:/dev
      - /opt/vc:/opt/vc
    command: ["python3", "-m", "pigeonwarden", "run", "deploy"]

  redis:
    image: redis:7
    container_name: pigeonwarden-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
